{
  "hash": "58843c9e5f87e4cd2c89a440dbabbeb1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Combining Dataframes with Different Categorical Structures\"\nformat: html\n---\n\n\n\n\n\n## Problem Description\nWhen working with multiple dataframes containing categorical variables, counts, and percentages, combining them with bind_rows() can introduce a large number of NA values. This happens because each dataframe contains different sets of categorical variables, leading to sparse structures when merged.\n\nFor example:\n\n- One dataframe may contain age groups and their population counts.\n- Another may include gender breakdowns but no age information.\n- Others focus on specific mental health diagnoses, with each diagnosis stored in its own separate dataframe.\n\nAfter using bind_rows(), the result includes many columns filled with NAs because the original dataframes don’t share all the same variables. This makes downstream analysis (such as creating tables and plots) more cumbersome.\n\n## Proposed Solution: Restructuring Before Merging\nTo make the data more manageable:\n\n1. Store each diagnosis separately, using:\n\n  - A binary indicator (1 = present, 0 = absent, NA = not applicable).\n  - A count column for how many individuals have that diagnosis.\n  - A percentage column representing the proportion of diagnosed individuals.\n\n2. Use pivot_longer() after merging to reshape the data into a more compact format, reducing sparsity.\n3. Ensure consistency in how categorical variables are represented before merging, avoiding unnecessary NAs.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install and restore from renv\nrenv::restore()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- The library is already synchronized with the lockfile.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidyr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a base demographic dataframe with adjusted values\ndf_demo <- data.frame(\n  age_cat = c(\"15-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\"),\n  count_age_cat = c(6, 18, 25, 12, 19, 2),\n  percent_age_cat = c(5.5, 22.0, 30.0, 14.5, 24.5, 3.5)\n)\n\n# Create a separate dataframe for Sex distribution with modified counts\ndf_sex <- data.frame(\n  Sex = c(\"Female\", \"Male\"),\n  count_sex = c(33, 51),\n  percent_sex = c(39.3, 60.7)\n)\n\n# Define separate dataframes for each diagnosis with modified counts and percentages\ndf_adhd <- data.frame(\n  CME_MentalHealthDiagnosis_adhd = c(1, 0, NA),\n  adhd_count = c(10, 3, 55),\n  adhd_percent = c(15.2, 4.5, 80.3)\n)\n\ndf_anxiety <- data.frame(\n  CME_MentalHealthDiagnosis_anxiety = c(1, 0, NA),\n  anxiety_count = c(14, 5, 60),\n  anxiety_percent = c(18.9, 6.8, 74.3)\n)\n\ndf_ocd <- data.frame(\n  CME_MentalHealthDiagnosis_ocd = c(1, 0, NA),\n  ocd_count = c(9, 4, 38),\n  ocd_percent = c(14.7, 7.5, 77.8)\n)\n\n# List the data frames for reference\ndf_list <- list(df_demo, df_sex, df_adhd, df_anxiety, df_ocd)\n\n# Print each dataframe separately for review\ndf_list\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n  age_cat count_age_cat percent_age_cat\n1   15-24             6             5.5\n2   25-34            18            22.0\n3   35-44            25            30.0\n4   45-54            12            14.5\n5   55-64            19            24.5\n6     65+             2             3.5\n\n[[2]]\n     Sex count_sex percent_sex\n1 Female        33        39.3\n2   Male        51        60.7\n\n[[3]]\n  CME_MentalHealthDiagnosis_adhd adhd_count adhd_percent\n1                              1         10         15.2\n2                              0          3          4.5\n3                             NA         55         80.3\n\n[[4]]\n  CME_MentalHealthDiagnosis_anxiety anxiety_count anxiety_percent\n1                                 1            14            18.9\n2                                 0             5             6.8\n3                                NA            60            74.3\n\n[[5]]\n  CME_MentalHealthDiagnosis_ocd ocd_count ocd_percent\n1                             1         9        14.7\n2                             0         4         7.5\n3                            NA        38        77.8\n```\n\n\n:::\n\n```{.r .cell-code}\n# Combining data using bind_rows()\ndf_combined <- bind_rows(df_list)\n\n# View the structure\nprint(df_combined)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   age_cat count_age_cat percent_age_cat    Sex count_sex percent_sex\n1    15-24             6             5.5   <NA>        NA          NA\n2    25-34            18            22.0   <NA>        NA          NA\n3    35-44            25            30.0   <NA>        NA          NA\n4    45-54            12            14.5   <NA>        NA          NA\n5    55-64            19            24.5   <NA>        NA          NA\n6      65+             2             3.5   <NA>        NA          NA\n7     <NA>            NA              NA Female        33        39.3\n8     <NA>            NA              NA   Male        51        60.7\n9     <NA>            NA              NA   <NA>        NA          NA\n10    <NA>            NA              NA   <NA>        NA          NA\n11    <NA>            NA              NA   <NA>        NA          NA\n12    <NA>            NA              NA   <NA>        NA          NA\n13    <NA>            NA              NA   <NA>        NA          NA\n14    <NA>            NA              NA   <NA>        NA          NA\n15    <NA>            NA              NA   <NA>        NA          NA\n16    <NA>            NA              NA   <NA>        NA          NA\n17    <NA>            NA              NA   <NA>        NA          NA\n   CME_MentalHealthDiagnosis_adhd adhd_count adhd_percent\n1                              NA         NA           NA\n2                              NA         NA           NA\n3                              NA         NA           NA\n4                              NA         NA           NA\n5                              NA         NA           NA\n6                              NA         NA           NA\n7                              NA         NA           NA\n8                              NA         NA           NA\n9                               1         10         15.2\n10                              0          3          4.5\n11                             NA         55         80.3\n12                             NA         NA           NA\n13                             NA         NA           NA\n14                             NA         NA           NA\n15                             NA         NA           NA\n16                             NA         NA           NA\n17                             NA         NA           NA\n   CME_MentalHealthDiagnosis_anxiety anxiety_count anxiety_percent\n1                                 NA            NA              NA\n2                                 NA            NA              NA\n3                                 NA            NA              NA\n4                                 NA            NA              NA\n5                                 NA            NA              NA\n6                                 NA            NA              NA\n7                                 NA            NA              NA\n8                                 NA            NA              NA\n9                                 NA            NA              NA\n10                                NA            NA              NA\n11                                NA            NA              NA\n12                                 1            14            18.9\n13                                 0             5             6.8\n14                                NA            60            74.3\n15                                NA            NA              NA\n16                                NA            NA              NA\n17                                NA            NA              NA\n   CME_MentalHealthDiagnosis_ocd ocd_count ocd_percent\n1                             NA        NA          NA\n2                             NA        NA          NA\n3                             NA        NA          NA\n4                             NA        NA          NA\n5                             NA        NA          NA\n6                             NA        NA          NA\n7                             NA        NA          NA\n8                             NA        NA          NA\n9                             NA        NA          NA\n10                            NA        NA          NA\n11                            NA        NA          NA\n12                            NA        NA          NA\n13                            NA        NA          NA\n14                            NA        NA          NA\n15                             1         9        14.7\n16                             0         4         7.5\n17                            NA        38        77.8\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: Identify groupings, come up with a plan\n# Step 2: Pivot all diagnosis-related columns into a long format\ndf_long <- df_combined %>%\n  pivot_longer(\n    cols = c(count_age_cat, percent_age_cat, count_sex, percent_sex, \n             starts_with(\"CME_MentalHealthDiagnosis_\"), \n             starts_with(\"count_\"), starts_with(\"percent_\")),\n    names_to = \"Metric\",\n    values_to = \"Value\"\n  ) %>%\n  mutate(\n    Category = case_when(\n      grepl(\"age_cat\", Metric) ~ \"Age\",\n      grepl(\"sex\", Metric, ignore.case = TRUE) ~ \"Sex\",\n      grepl(\"CME_MentalHealthDiagnosis\", Metric) ~ gsub(\"CME_MentalHealthDiagnosis_\", \"\", Metric),\n      TRUE ~ \"Other\"\n    )\n  )\n\n# Step 3: Extract variable names and standardize across the dataframe\ndf_long <- df_long %>%\n  mutate(\n    Variable = case_when(\n      Category == \"Age\" ~ age_cat,\n      Category == \"Sex\" ~ Sex,\n      Category == \"Mental Health Diagnosis\" ~ gsub(\"CME_MentalHealthDiagnosis_\", \"\", Metric),\n      TRUE ~ NA_character_\n    ),\n    Metric = case_when(\n      grepl(\"count\", Metric) ~ \"Count\",\n      grepl(\"percent\", Metric) ~ \"Percent\",\n      TRUE ~ Metric\n    )\n  ) %>%\n  select(Category, Variable, Metric, Value) %>%\n  pivot_wider(names_from = Metric, values_from = Value) %>%\n  filter(!is.na(Variable)) %>%  # remove rows where Variable is NA from pivot_longer\n  arrange(Category, Variable)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Values from `Value` are not uniquely identified; output will contain list-cols.\n• Use `values_fn = list` to suppress this warning.\n• Use `values_fn = {summary_fun}` to summarise duplicates.\n• Use the following dplyr code to identify duplicates.\n  {data} |>\n  dplyr::summarise(n = dplyr::n(), .by = c(Category, Variable, Metric)) |>\n  dplyr::filter(n > 1L)\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Alternative strategy - reshape initial dataframes before combination\n\n# Step 1: Convert df_demo (Age Data) to long format\ndf_demo_long <- df_demo %>%\n  pivot_longer(\n    cols = c(count_age_cat, percent_age_cat),\n    names_to = \"Metric\",\n    values_to = \"Value\"\n  ) %>%\n  mutate(\n    Category = \"Age\",\n    Variable = as.character(age_cat),  # Ensure Variable is character\n    Metric = case_when(\n      grepl(\"count\", Metric) ~ \"Count\",\n      grepl(\"percent\", Metric) ~ \"Percent\"\n    )\n  ) %>%\n  select(Category, Variable, Metric, Value) %>%\n  pivot_wider(names_from = Metric, values_from = Value)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 2: Convert df_sex (Sex Data) to long format\ndf_sex_long <- df_sex %>%\n  pivot_longer(\n    cols = c(count_sex, percent_sex),\n    names_to = \"Metric\",\n    values_to = \"Value\"\n  ) %>%\n  mutate(\n    Category = \"Sex\",\n    Variable = as.character(Sex),  # Ensure Variable is character\n    Metric = case_when(\n      grepl(\"count\", Metric) ~ \"Count\",\n      grepl(\"percent\", Metric) ~ \"Percent\"\n    )\n  ) %>%\n  select(Category, Variable, Metric, Value) %>%\n  pivot_wider(names_from = Metric, values_from = Value)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 3: Convert Diagnosis Dataframes to Long Format\nconvert_diagnosis <- function(df, diagnosis_name) {\n  df %>%\n    rename(Variable = 1) %>%  # Rename first column to \"Variable\" (1, 0, NA)\n    mutate(Variable = as.character(Variable)) %>%  # Convert to character to match other tables\n    pivot_longer(\n      cols = ends_with(\"_count\") | ends_with(\"_percent\"),  # Match actual column names\n      names_to = \"Metric\",\n      values_to = \"Value\"\n    ) %>%\n    mutate(\n      Category = diagnosis_name,\n      Metric = case_when(\n        grepl(\"_count\", Metric) ~ \"Count\",\n        grepl(\"_percent\", Metric) ~ \"Percent\"\n      )\n    ) %>%\n    select(Category, Variable, Metric, Value) %>%\n    pivot_wider(names_from = Metric, values_from = Value)\n}\n\n# Convert each diagnosis dataframe\ndf_adhd_long <- convert_diagnosis(df_adhd, \"ADHD\")\ndf_anxiety_long <- convert_diagnosis(df_anxiety, \"Anxiety\")\ndf_ocd_long <- convert_diagnosis(df_ocd, \"OCD\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 4: Combine Everything (Ensuring Variable is Character)\ndf_final <- bind_rows(df_demo_long, df_sex_long, df_adhd_long, df_anxiety_long, df_ocd_long) %>%\n  arrange(Category, Variable)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Display the transformed dataframe\nprint(df_final)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 17 × 4\n   Category Variable Count Percent\n   <chr>    <chr>    <dbl>   <dbl>\n 1 ADHD     0            3     4.5\n 2 ADHD     1           10    15.2\n 3 ADHD     <NA>        55    80.3\n 4 Age      15-24        6     5.5\n 5 Age      25-34       18    22  \n 6 Age      35-44       25    30  \n 7 Age      45-54       12    14.5\n 8 Age      55-64       19    24.5\n 9 Age      65+          2     3.5\n10 Anxiety  0            5     6.8\n11 Anxiety  1           14    18.9\n12 Anxiety  <NA>        60    74.3\n13 OCD      0            4     7.5\n14 OCD      1            9    14.7\n15 OCD      <NA>        38    77.8\n16 Sex      Female      33    39.3\n17 Sex      Male        51    60.7\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(df_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 7\n  Category Variable Count  Percent CME_MentalHealthDiag…¹ CME_MentalHealthDiag…²\n  <chr>    <chr>    <list> <list>  <list>                 <list>                \n1 Age      15-24    <dbl>  <dbl>   <NULL>                 <NULL>                \n2 Age      25-34    <dbl>  <dbl>   <NULL>                 <NULL>                \n3 Age      35-44    <dbl>  <dbl>   <NULL>                 <NULL>                \n4 Age      45-54    <dbl>  <dbl>   <NULL>                 <NULL>                \n5 Age      55-64    <dbl>  <dbl>   <NULL>                 <NULL>                \n6 Age      65+      <dbl>  <dbl>   <NULL>                 <NULL>                \n7 Sex      Female   <dbl>  <dbl>   <NULL>                 <NULL>                \n8 Sex      Male     <dbl>  <dbl>   <NULL>                 <NULL>                \n# ℹ abbreviated names: ¹​CME_MentalHealthDiagnosis_adhd,\n#   ²​CME_MentalHealthDiagnosis_anxiety\n# ℹ 1 more variable: CME_MentalHealthDiagnosis_ocd <list>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# # Are there any NAs the should be filled?\n# df_long <- df_long %>%\n#   mutate(\n#     Diagnosis_Present = ifelse(is.na(Diagnosis_Present), 0, Diagnosis_Present),\n#     count = ifelse(is.na(count), 0, count),\n#     percent = ifelse(is.na(percent), 0, percent)\n#   )\n# \n# # Ensure categorical fields do not lose NAs for 'unknown' or 'not reported'\n# df_long <- df_long %>%\n#   mutate(\n#     Sex = ifelse(is.na(Sex), \"Not Reported\", Sex),\n#     age_cat = ifelse(is.na(age_cat), \"Unknown\", age_cat)\n#   )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nreadr::write_csv(df_combined, \"combine-df-diff-categoricals.csv\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}